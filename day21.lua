rule2 = {{"../..",".../#.#/..."},
{"#./..","..#/..#/#.."},
{"##/..",".../#../..#"},
{".#/#.","#../.../..."},
{"##/#.","#.#/.#./#.."},
{"##/##","..#/#.#/..#"}}
rule3 = {{".../.../...",".#../#..#/#.../.#.."},
{"#../.../...","..##/..##/.#.#/...."},
{".#./.../...","..##/..##/.###/##.."},
{"##./.../...","..../.##./#.##/..#."},
{"#.#/.../...","####/#.##/#.##/#.#."},
{"###/.../...","#..#/..#./..../##.#"},
{".#./#../...","..#./.#../...#/#.##"},
{"##./#../...","..../#.##/#..#/.#.."},
{"..#/#../...","##.#/####/###./###."},
{"#.#/#../...","..../#.##/.###/#.#."},
{".##/#../...","..#./##.#/####/..##"},
{"###/#../...","..#./.##./...#/..#."},
{".../.#./...",".###/#.../.#../####"},
{"#../.#./...","###./.#.#/#.##/##.#"},
{".#./.#./...","..##/..#./###./..#."},
{"##./.#./...","#..#/..#./###./...#"},
{"#.#/.#./...","#.../##.#/#.##/#..#"},
{"###/.#./...","...#/#..#/####/##.#"},
{".#./##./...","#.##/#.##/..../#.#."},
{"##./##./...","..##/###./..#./####"},
{"..#/##./...","..../##../##.#/.##."},
{"#.#/##./...","##../####/####/.#.#"},
{".##/##./...","..../##.#/.###/##.."},
{"###/##./...",".#../#.#./.#../..##"},
{".../#.#/...","####/#.#./..##/#..#"},
{"#../#.#/...",".#../.#../#..#/...."},
{".#./#.#/...","..##/.##./####/#.#."},
{"##./#.#/...","..#./###./.#../...."},
{"#.#/#.#/...","..#./..#./...#/#..."},
{"###/#.#/...","###./.#../##../####"},
{".../###/...","#.##/####/####/..##"},
{"#../###/...",".#.#/...#/###./...#"},
{".#./###/...","..../.#.#/.#../...."},
{"##./###/...","...#/.###/..../.##."},
{"#.#/###/...","..##/###./.#../#..#"},
{"###/###/...",".###/..#./..#./.###"},
{"..#/.../#..",".##./###./####/#.#."},
{"#.#/.../#..","####/#.../#.../..##"},
{".##/.../#..","###./#..#/..#./.#.."},
{"###/.../#..",".###/.##./#.#./.###"},
{".##/#../#..","##.#/...#/.#.#/...#"},
{"###/#../#..","#.##/..#./..../#..#"},
{"..#/.#./#..","#..#/##.#/.##./####"},
{"#.#/.#./#..","###./..##/#..#/#..#"},
{".##/.#./#..",".#../..../...#/...#"},
{"###/.#./#..",".#../##../.###/..#."},
{".##/##./#..","##../..##/##../##.#"},
{"###/##./#..","#.##/#..#/.###/####"},
{"#../..#/#..","##.#/####/#.../..##"},
{".#./..#/#..","#..#/..../..../###."},
{"##./..#/#..","#..#/##.#/##.#/#.#."},
{"#.#/..#/#..",".###/##.#/####/#..."},
{".##/..#/#..","####/.##./...#/#..#"},
{"###/..#/#..",".#.#/####/##.#/...#"},
{"#../#.#/#..","..##/.##./..##/##.."},
{".#./#.#/#..","#.../##../..##/..#."},
{"##./#.#/#..","...#/##.#/#..#/.#.."},
{"..#/#.#/#..","#.#./##../#.##/###."},
{"#.#/#.#/#..","##../##.#/#.#./...."},
{".##/#.#/#..","####/...#/####/.#.."},
{"###/#.#/#..","..../.#../.#../...."},
{"#../.##/#..",".#.#/..#./#..#/.###"},
{".#./.##/#..","#.../.#.#/.###/.##."},
{"##./.##/#..","#.#./#.#./.#../###."},
{"#.#/.##/#..","####/##../.##./####"},
{".##/.##/#..","#.../#.#./#.##/###."},
{"###/.##/#..","####/####/..../####"},
{"#../###/#..","####/.##./...#/##.#"},
{".#./###/#..",".#../#.##/#..#/..##"},
{"##./###/#..","#.#./..##/#.../..##"},
{"..#/###/#..","#.##/.###/#.#./###."},
{"#.#/###/#..","#.##/#.##/..../#..#"},
{".##/###/#..",".##./#.#./..##/####"},
{"###/###/#..",".##./#..#/#.../###."},
{".#./#.#/.#.","#.#./#..#/#..#/##.#"},
{"##./#.#/.#.","...#/#.#./##.#/###."},
{"#.#/#.#/.#.","##.#/..##/##.#/#.##"},
{"###/#.#/.#.",".#.#/..#./##../.##."},
{".#./###/.#.","#..#/..#./..##/#..."},
{"##./###/.#.","####/.#.#/####/..#."},
{"#.#/###/.#.","#.#./..##/##../#..#"},
{"###/###/.#.","...#/..../..../#.#."},
{"#.#/..#/##.","..#./.##./###./.#.#"},
{"###/..#/##.","#.../###./...#/####"},
{".##/#.#/##.","..../..../.###/##.."},
{"###/#.#/##.","##../..../#.#./.##."},
{"#.#/.##/##.",".#.#/##../..##/#.#."},
{"###/.##/##.","###./####/...#/.#.."},
{".##/###/##.","..##/#.../..##/.#.#"},
{"###/###/##.","..##/...#/.###/.#.."},
{"#.#/.../#.#","..##/#.../##.#/...."},
{"###/.../#.#","#.##/#..#/..../##.."},
{"###/#../#.#","#.../..../##.#/..#."},
{"#.#/.#./#.#","###./..##/.#../.##."},
{"###/.#./#.#","..../#..#/.###/#..#"},
{"###/##./#.#",".#.#/###./##.#/.###"},
{"#.#/#.#/#.#","..../..../.##./#..#"},
{"###/#.#/#.#",".###/.#.#/...#/.###"},
{"#.#/###/#.#",".#.#/##../.#../.#.."},
{"###/###/#.#",".#.#/.##./#.##/...."},
{"###/#.#/###","..#./..#./..#./..##"},
{"###/###/###","##.#/..##/.#.#/...."}}
input = {".#.",
"..#",
"###"}
art = {}
for i = 1, 3 do
    if not art[i] then art[i] = {} end
    for j = 1, 3 do
        local str = string.sub(input[j],i,i)
        if str == "#" then
            art[i][j] = 1
        else
            art[i][j] = 0
        end
    end
end
function debugprint(art) -- print a art (debug)
    local poi = ""
    for i = 1, #art do
        poi = poi .. "-"
    end
    print(poi)
    for y = 1, #art do
        local str = ""
        for x = 1, #art do
            if not art[x] then art[x] = {} end
            if art[x][y] == 1 then
                str = str .. "#"
            elseif art[x][y] == 0 then
                str = str .. "."
            else
                str = str .. "o"
            end
        end
        print(str)
    end
end
function copy(art) -- copy a art (so a change made on it don't affect the original)
    local nart = {}
    for x = 1, #art do
        if not nart[x] then nart[x] = {} end
        for y = 1, #art do
            nart[x][y] = art[x][y]
        end
    end
    return nart
end
--[[credits to
    https://www.geeksforgeeks.org/inplace-rotate-square-matrix-by-90-degrees/
    https://www.geeksforgeeks.org/rotate-matrix-90-degree-without-using-extra-space-set-2/
--]]
function rotate(art) -- rotate a art anti - clockwize
    --transpose
    for x = 1, #art do
        for y = x, #art do
            art[x][y], art[y][x] = art[y][x], art[x][y]
        end
    end
    --invert column
    for x = 1, #art do
        for y = 1,#art/2 do
            art[x][y], art[x][#art + 1 - y] = art[x][#art + 1 - y], art[x][y]
        end
    end
end
function flip(art) -- flip a art
    for x = 1, #art/2 do
        for y = 1, #art do
            art[x][y], art[#art + 1 - x][y] = art[#art + 1 - x][y], art[x][y]
        end
    end
end
function enchantaux(simp,s1,s2)
    return (simp == s1) or (simp == s2)
end
function action(obj,f,...)
    if #{...} > 0 then
        f(obj)
        action(obj,...)
    else
        f(obj)
    end
end
function enchant(art, n)
    --[[
        art1 = 0
        art2 = 0F
        art3 = 90
        art4 = 90F
        art5 = 180
        art6 = 180F
        art7 = 270
        art8 = 270F
    --]]
    local art1 = copy(art)
    action(art1,flip)
    local eartsimp
    repeat
        local sart, sart1 = tosimplyfied(art), tosimplyfied(art1)
        if n == 2 then
            for i, s in pairs(rule2) do
                if enchantaux(s[1], sart, sart1) then
                    eartsimp = s[2]
                    break
                end
            end
        else
            for i, s in pairs(rule3) do
                if enchantaux(s[1], sart, sart1) then
                    eartsimp = s[2]
                    break
                end
            end
        end
        action(art,rotate)
        action(art1,rotate)
    until eartsimp
    return toart(eartsimp)
end
function artbreak(art,n) -- break a art in multiple small arts (and also enchant now)
    local max = #art/n
    local t = {}
    for i = 1, max do
        for j = 1, max do
            local nart = {}
            for x = n*(i - 1) + 1, n*i do
                local xr = (x - 1)%n + 1
                if not nart[xr] then nart[xr] = {} end
                for y = n*(j - 1) + 1, n*j do
                    local yr = (y - 1)%n + 1
                    nart[xr][yr], art[x][y] = art[x][y], nil
                end
            end
            nart = enchant(nart,n)
            table.insert(t,nart)
        end
    end
    return t
end
function trans(input)
    if input == 0 then
        return "."
    elseif input == 1 then
        return "#"
    elseif input == "." then
        return 0
    elseif input == "#" then
        return 1
    else
        return input
    end
end
function tosimplyfied(art) --convert a art to simplified version
    local str = ""
    for i = 1, # art do
        for j = 1, # art do
            if (j == #art) and (i < #art) then
                str = str .. trans(art[j][i]) .. "/"
            else
                str = str .. trans(art[j][i])
            end
        end
    end
    return str
end
function toart(simp) --convert simplified version to art
    local t1 = {}
    local i = 1
    local bar = string.find(simp, "/", i)
    while bar do
        local t2 = {}
        local str = string.sub(simp, i, bar - 1)
        for j = 1, #str do
            local fstr = string.sub(str, j, j)
            table.insert(t2,trans(fstr))
        end
        table.insert(t1,t2)
        i = bar + 1
        bar = string.find(simp, "/", i)
    end
    local t2 = {}
    local str = string.sub(simp, i, #simp)
    for j = 1, #str do
        local fstr = string.sub(str, j, j)
        table.insert(t2,trans(fstr))
    end
    table.insert(t1,t2)
    for x = 1, #t1 do
        for y = x, #t1 do
            t1[x][y], t1[y][x] = t1[y][x], t1[x][y]
        end
    end
    return t1
end
function tm1(t1,t2) -- merges type 1
    for i = 1, #t1 do
        for j, s in pairs(t2[i]) do
            table.insert(t1[i],s)
            t2[i] = nil
        end
    end
    t2 = nil
end
function tm2(t1,t2) -- merges type 2
    local size = #t1
    for i = #t1 + 1, #t1 + #t2 do
        t1[i], t2[i - size] = t2[i - size], nil
    end
    t2 = nil
end
function artjoin(list) -- join multiples art in one
    local max = math.sqrt(#list) -- simetry, also n^2 = #list
    local nart
    k = 0
    for i = 1, max do
        local nsart
        for j = 1, max do
            if not nsart then
                k = k + 1
                nsart = list[k]
            else
                k = k + 1
                tm1(nsart,list[k])
            end
        end
        if not nart then
            nart = nsart
        else
            tm2(nart,nsart)
        end
    end
    k = nil
    return nart
end
function count(art) -- count how many pixels on a art have
    local count = 0
    for i = 1, #art do
        for j = 1, #art do
            if art[i][j] == 1 then
                count = count + 1
            end
        end
    end
    return count
end
for i = 1, 18 do
    print("process " .. i)
    if #art % 2 == 0 then
        list = artbreak(art,2)
    elseif #art % 3 == 0 then
        list = artbreak(art,3)
    end
    art = artjoin(list)
    list = nil
    if i == 5 then
        print("part I")
        print("there has " .. count(art) .. " activated pixels")
    elseif i == 18 then
        print("part II")
        print("there has " .. count(art) .. " activated pixels")
    end
end
